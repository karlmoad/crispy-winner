<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">

<script type="application/javascript" src="../../bower_components/adal-angular/dist/adal.min.js"></script>
<script type="application/javascript" src="./upmc-auth.js"></script>

<dom-module id="azure-login-component">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <div id="divlogin">
            <paper-button on-tap="login" raised>Login</paper-button>
        </div>
        <div id="divlogout">
            <paper-menu-button verticalOffset="10">
                <paper-button class="dropdown-trigger">[[displayName]]</paper-button>
                <paper-menu class="dropdown-content">
                    <paper-item on-tap="logout">Logout</paper-item>
                    <paper-item on-tap="renew">Renew Token</paper-item>
                </paper-menu>
            </paper-menu-button>
        </div>
    </template>

    <script>
        Polymer({

            is: 'azure-login-component',

            properties: {
                tenant: {
                    type: String
                },
                clientid: {
                    type: String
                },
                logout: {
                    type: String
                },
                storage: {
                    type: String,
                },
                displayName: {
                    type: String,
                    value: "Hello:",
                    notify: true
                },
                config: {
                    type: Object,
                },
                authenContext:{
                    type: Object
                },
                authorContext:{
                    type: Object
                },
                user: {
                    type: Object,
                    notify: true
                },
                token:{
                    type: String,
                    notify:true
                }
            },

            getConfig: function(){
                return {
                    tenant: this.tenant,
                    clientId: this.clientid,
                    postLogoutRedirectUri: window.location.origin,
                    cacheLocation: 'localStorage', // enable this for IE, as sessionStorage does not work for localhost.
                    contexts: [],
                    logout: null,
                    storeToken: true,
                    authorizeUrl: 'http://localhost:31000/api'
                };
            },

            ready: function() {

                this.authenContext = new AuthenticationContext(this.getConfig());
                this.authorContext = new AuthorizationContext(this.getConfig());

                var isCallback = this.authenContext.isCallback(window.location.hash);
                console.log("Callback ?: %s", isCallback);
                this.authenContext.handleWindowCallback();

                if (isCallback && !this.authenContext.getLoginError()) {
                    window.location = this.authenContext._getItem(this.authenContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
                }

                var accessToken = this.authenContext._getItem(this.authenContext.CONSTANTS.STORAGE.IDTOKEN);

                var usr = this.authenContext.getCachedUser();
                if (usr) {
                    this.$.divlogin.hidden = true;
                    this.$.divlogout.hidden = false;

                    this.authorContext.authorize(accessToken, function(error, response){
                        if(error){
                            console.log("Error: %s, forcing logout", error);
                            this.authenContext.logOut();
                        }
                        else{
                            //Load user data
                            this.user = response.user;
                            this.token = response.token;
                            this.displayName = this.user.uid;
                        }
                    }.bind(this)); //Make sure the call remains bound to current context
                }else{
                    this.$.divlogin.hidden = false;
                    this.$.divlogout.hidden = true;
                }
            },

            renew: function(){
                this.authorContext.renew(function(error, response){
                    if(error){
                        console.log("Error: %s, forcing logout", error);
                        this.authenContext.logOut();
                    }
                    else{
                        //Load user data
                        this.user = response.user;
                        this.token = response.token;
                    }
                }.bind(this)); //Make sure the call remains bound to current context
            },

            login: function() {
                this.authenContext.login();
            },

            logout: function(){
                this.authenContext.logOut();
                this.authorContext.logOut();
            }
        });
    </script>
</dom-module>